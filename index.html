<script>
  let lastCallTime = 0;

  async function summarizeWithAI() {
    const text = document.getElementById('text-input').value;
    const key = document.getElementById('ai-key').value.trim();
    const provider = document.getElementById('ai-provider').value;
    const output = document.getElementById('summary-output');

    if (!key || !text) {
      alert('Lütfen önce metni ve geçerli bir API anahtarını girin.');
      return;
    }

    const now = Date.now();
    if (now - lastCallTime < 5000) {
      alert('Çok hızlı istek gönderdiniz. Lütfen birkaç saniye bekleyin.');
      return;
    }
    lastCallTime = now;

    output.value = 'Özetleniyor...';

    try {
      if (provider === 'openai') {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${key}`
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [{ role: 'user', content: 'Bu metni özetle:\n' + text }],
            max_tokens: 500,
            temperature: 0.5
          })
        });

        if (response.status === 429) {
          output.value = 'Çok fazla istek gönderildi (429). Lütfen bir süre sonra tekrar deneyin.';
          return;
        }

        if (!response.ok) {
          const errorData = await response.json();
          output.value = `API Hatası: ${errorData.error?.message || 'Bilinmeyen hata'}`;
          return;
        }

        const data = await response.json();
        output.value = data.choices?.[0]?.message?.content || 'Özet alınamadı.';
      } else if (provider === 'gemini') {
        output.value = 'Gemini henüz doğrudan desteklenmiyor.';
      } else {
        output.value = 'Bilinmeyen sağlayıcı.';
      }
    } catch (error) {
      output.value = 'Hata oluştu: ' + error.message;
    }
  }
</script>
